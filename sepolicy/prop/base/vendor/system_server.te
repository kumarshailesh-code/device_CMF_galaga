# ==============================================
# MTK Policy Rule
# ==============================================

# Add by : Jackie
# Date : WK15.34
# Operation : Migration
# Purpose : Allow drmserver to access some system_server opreration on M
#           and allow drmserver access file stored in sdcard
allow drmserver system_server:file getattr;
allow system_server drmserver:drmservice openDecryptSession;

# Date: WK16.30
# Operation : Migration
# Purpose : for system_server operate /dev/RT_Monitor when enable hang detect
allow system_server RT_Monitor_device:chr_file r_file_perms;

# Date : 2016/07/11
# Operation : Migration
# Purpose : Add permission for gpu access
allow system_server dri_device:chr_file rw_file_perms;

# Date : W17.24
# Purpose: Allow to use HAL PQ
hal_client_domain(system_server, hal_mtk_pq)

# Date:W17.33
# Operation : camera hal developing
# Purpose : camera hal binder_call permission
binder_call(system_server, mtk_hal_camera)

# Date:W17.36
# Operation : Migration
# Purpose : Allow to send signal
allow system_server netd:process signal;

# Date:W17.07
# Operation : dfps hal
# Purpose : dfps hal interface permission
hal_client_domain(system_server, hal_dfps)

allow system_server audioserver:file w_file_perms;

# Date : 2023/02/22
# Purpose : allow INetdAgent AIDL and HIDL find permission for system_server
hal_client_domain(system_server, mtk_hal_netdagent)

# Date : W19.12
# Operation : For DuraSpeed Migration
allow system_server proc_cpu_loading:file rw_file_perms;
userdebug_or_eng(`
allow system_server debugfs_tracing_debug:file r_file_perms;
')
allow system_server proc_low_memory_hit:file rw_file_perms;
allow system_server duraspeed_data_file:dir create_dir_perms;
allow system_server duraspeed_data_file:file create_file_perms;

# Date : WK18.36
# Operation : omadm aidl
# Purpose : aidl interface permission
hal_client_domain(system_server, hal_mtk_omadm)

# Date : WK19.29
# Operation : nwk_opt hal
# Purpose : nwk_opt hal permission
hal_client_domain(system_server, hal_mtk_nwk_opt)

# Date:2020/08/07
# Operation:R Migration
userdebug_or_eng(` allow system_server md_monitor:process signal; ')

# Date:2020/08/26
# Operation:kill hal_drm_widevine permission when ANR happened
allow system_server hal_drm_widevine:process signal;

# Date:2020/09/03
# Operation:R Migration
allow system_server proc_ion:dir search;

# Date:2020/09/07
# Operation:R Migration
allow system_server proc_m4u_dbg:dir search;

# Date:2020/09/08
# Operation:R Migration
allow system_server proc_displowpower:dir search;
allow system_server proc_freqhopping:file getattr;

# Date:2020/09/11
# Operation:R Migration
allow system_server proc_freqhopping:dir search;

# Date:2020/09/18
# Operation:R Migration
allow system_server procfs_gpu_img:dir { search getattr };

# Date:2020/09/30
# Operation:R Migration
allow system_server procfs_gpu_img:file getattr;

# Read/Write /proc/pressure/cpu
allow system_server proc_pressure_cpu:file rw_file_perms;

# Search /proc/usb/plat
allow system_server proc_usb_plat:dir search;

# Search /proc/gpufreqv2
allow system_server proc_gpufreqv2:dir search;

# Search /proc/mtkfb
allow system_server proc_mtkfb:dir search;

# Search /proc/stat
allow system_server proc_stat:dir search;

# Date: 2021/08/10
# Operation: S Migration
# Purpose: InputReader read files under power_supply to detect battery device
allow system_server sysfs_power_supply:dir r_dir_perms;
allow system_server sysfs_power_supply:file r_file_perms;
allow system_server sysfs_usb_nonplat:file r_file_perms;

# Access devices.
allow system_server touch_device:chr_file rw_file_perms;
allow system_server stpant_device:chr_file rw_file_perms;
allow system_server devmap_device:chr_file r_file_perms;
allow system_server irtx_device:chr_file rw_file_perms;
allow system_server qemu_pipe_device:chr_file rw_file_perms;
allow system_server wmtWifi_device:chr_file w_file_perms;

# Add for proc_btdbg
allow system_server proc_btdbg:file rw_file_perms;

# Add for bootprof
allow system_server proc_bootprof:file rw_file_perms;


# Perform Binder IPC.
allow system_server zygote:binder impersonate;

# For dumpsys.
allow system_server aee_dumpsys_data_file:file w_file_perms;

# Querying zygote socket.
allow system_server zygote:unix_stream_socket { getopt getattr };

# Allow system_server to read/write /sys/power/dcm_state
allow system_server sysfs_dcm:file rw_file_perms;

# Data : WK16.42
# Operator: Whitney bring up
# Purpose: call surfaceflinger due to powervr
allow system_server surfaceflinger:fifo_file rw_file_perms;

# Date : W16.42
# Operation : Integration
# Purpose : DRM / DRI GPU driver required
allow system_server gpu_device:dir search;

# Date : W16.43
# Operation : Integration
# Purpose : DRM / DRI GPU driver required
allow system_server sw_sync_device:chr_file rw_file_perms;

# Date : WK16.44
# Purpose: Allow to access UART1 ttyMT1
allow system_server ttyMT_device:chr_file rw_file_perms;

# Date : WK17.52
# Purpose: Allow to access UART1 ttyS
allow system_server ttyS_device:chr_file rw_file_perms;

# Date:W16.46
# Operation : thermal hal Feature developing
# Purpose : thermal hal interface permission
allow system_server proc_mtktz:dir search;
allow system_server proc_mtktz:file r_file_perms;

# Date:W17.02
# Operation : audio hal developing
# Purpose : audio hal interface permission
allow system_server mtk_hal_audio:process { getsched setsched };

# Dat: 2017/02/14
# Purpose: allow get telephony Sensitive property
get_prop(system_server, vendor_mtk_telephony_sensitive_prop)

# Date:W17.07
# Operation : bt hal
# Purpose : bt hal interface permission
binder_call(system_server, mtk_hal_bluetooth)

# Date:W17.08
# Operation : sensors hal developing
# Purpose : sensors hal interface permission
binder_call(system_server, mtk_hal_sensors)

# Operation : light hal developing
# Purpose : light hal interface permission
binder_call(system_server, mtk_hal_light)

# Date:W17.31
# Operation : mpe sensor hidl developing
# Purpose : mpe sensor hidl permission
binder_call(system_server, mnld)

# Date:W22.52
# Operation : mpe sensor hidl developing
# Purpose : mpe sensor hidl permission
binder_call(system_server, gnss_daemon)

# Date : WK17.32
# Operation : Migration
# Purpose : for network log dumpsys setting/netd information
#           audit(0.0:914): avc: denied { write } for path="pipe:[46088]"
#           dev="pipefs" ino=46088 scontext=u:r:system_server:s0
#           tcontext=u:r:netdiag:s0 tclass=fifo_file permissive=1
allow system_server netdiag:fifo_file w_file_perms;

# Date : WK17.32
# Operation : Migration
# Purpose : for DHCP Client ip recover functionality
allow system_server dhcp_data_file:dir rw_dir_perms;
allow system_server dhcp_data_file:file create_file_perms;

# Date:W17.35
# Operation : lbs hal
# Purpose : lbs hidl interface permission
hal_client_domain(system_server, hal_mtk_lbs)

# Date : WK17.12
# Operation : MT6799 SQC
# Purpose : Change thermal config
get_prop(system_server, vendor_mtk_thermal_config_prop)

# Date : WK17.43
# Operation : Migration
# Purpose : perfmgr permission
allow system_server proc_perfmgr:dir r_dir_perms;
allow system_server proc_perfmgr:file r_file_perms;
allowxperm system_server proc_perfmgr:file ioctl {
  PERFMGR_FPSGO_QUEUE
  PERFMGR_FPSGO_DEQUEUE
  PERFMGR_FPSGO_QUEUE_CONNECT
  PERFMGR_FPSGO_BQID
  PERFMGR_FPSGO_SWAP_BUFFER
  PERFMGR_FPSGO_ACQUIRE
  PERFMGR_FPSGO_BUFFER_QUOTA
};

# Date : W18.22
# Operation : MTK wifi hal migration
# Purpose : MTK wifi hal interface permission
binder_call(system_server, mtk_hal_wifi)

# Date : W19.15
# Operation : alarm device permission
# Purpose : support power-off alarm
allow system_server alarm_device:chr_file rw_file_perms;

# Date : WK19.7
# Operation: Q migration
# Purpose : Allow system_server to use ioctl/ioctlcmd
allow system_server proc_ged:file rw_file_perms;
allowxperm system_server proc_ged:file ioctl { proc_ged_ioctls };

# Date: 2019/06/14
# Operation : when WFD turnning on, turn off hdmi
hal_client_domain(system_server, hal_mtk_hdmi)

# Date:2019/10/09
# Operation:Q Migration
allow system_server proc_cmdq_debug:file getattr;
allow system_server proc_cmdq_debug:dir search;
allow system_server proc_last_kmsg:file r_file_perms;
allow system_server proc_cm_mgr:dir search;
allow system_server proc_isp_p2:dir search;
allow system_server proc_thermal:dir search;
allow system_server proc_atf_log:dir search;
allow system_server proc_cpufreq:dir search;
allow system_server proc_mtkcooler:dir search;
allow system_server proc_ppm:dir search;

# Date : 2019/10/11
# Operation : Q Migration
allow system_server proc_wlan_status:file getattr;

# Date : 2019/10/11
# Operation : Q Migration
allow system_server sysfs_pages_shared:file r_file_perms;
allow system_server sysfs_pages_sharing:file r_file_perms;
allow system_server sysfs_pages_unshared:file r_file_perms;
allow system_server sysfs_pages_volatile:file r_file_perms;

# Date:2019/10/14
# Operation: Q Migration
# Purpose : power_hal_mgr_service may use libmtkperf_client
allow system_server sysfs_boot_mode:file r_file_perms;

# Date : 2019/10/22
# Operation : Q Migration
allow system_server self:capability sys_module;

# Date : 2019/10/22
# Operation : Q Migration
dontaudit system_server sdcardfs:file r_file_perms;

# Date : 2019/10/26
# Operation : Q Migration
allow system_server mtk_hal_camera:process sigkill;
allow system_server kernel:system syslog_read;

# Date : 2019/10/30
# Operation : Q Migration
allow system_server proc_chip:dir search;
allow system_server zygote:process setsched;

# Date : 2019/11/29
# Operation : Q Migration
allow system_server storage_stub_file:dir getattr;

# Date : 2020/05/12
# Operation : R Migration
allow system_server proc_ppm:file r_file_perms;

# Date: 2019/11/12
# Purpose: Allow system server to access mtk jpeg
allow system_server proc_mtk_jpeg:file rw_file_perms;
allowxperm system_server proc_mtk_jpeg:file ioctl {
      JPG_BRIDGE_DEC_IO_LOCK
      JPG_BRIDGE_DEC_IO_WAIT
      JPG_BRIDGE_DEC_IO_UNLOCK
};

# Date : 2020/06/30
# Operation : R Migration
dontaudit system_server kernel:process sigkill;

# Date : 2021/07/20
# Operation : S Migration
# Purpose : dontaudit system_server is not allowed to getopt 'shell' type of unix_stream_socket
dontaudit system_server shell:unix_stream_socket getopt;

# Search /proc/cpuidle
allow system_server proc_cpuidle:dir search;

# Date:2021/08/23
# Operation:allow CachedAppOptimi to getattr from /proc/mtk_mdp_debug
allow system_server proc_mtk_mdp_debug:file getattr;

# Search /proc/mtk_mdp_debug
allow system_server proc_mtk_mdp_debug:dir search;

# For AudioManager/WiredAccessoryManager, for Extcon uevent
# listeners
allow system_server sysfs_extcon:file r_file_perms;

# When ams cleans up the process, it should not kill mtk_hal_bluetooth
dontaudit system_server mtk_hal_bluetooth:process sigkill;

# Write tempfs for CachedAppOptimi
allow system_server tmpfs:file w_file_perms;

# Write mediaserver_tmpfs for CachedAppOptimi
allow system_server mediaserver_tmpfs:file w_file_perms;

# Purpose : dontaudit system_server is not allowed to kill eara_io
dontaudit system_server hal_wifi_default:process sigkill;
dontaudit system_server eara_io:process sigkill;

# Purpose : dontaudit system_server is not allowed to kill mtk_hal_audio
dontaudit system_server mtk_hal_audio:process sigkill;

# Date : 2022/04/25
# Operation : HDR10plus adaptive feature
binder_call(system_server, mtk_hal_mmlpq)

# Date : 2022/07/27
# Operation : dontaudit system_server access vendor file
dontaudit system_server vendor_file:dir read;

dontaudit system_server ringtone_file:dir relabelfrom;

# Date:2023/03/15
# allow system server Search powerHal point
allow system_server proc_mgq:dir search;
allow system_server proc_stpbt:dir search;
allow system_server proc_easmgr:dir search;
allow system_server proc_cpumgr:dir search;
allow system_server proc_cpuqosmgr:dir search;
allow system_server proc_powerhal_cpu_ctrl:dir search;
allow system_server proc_touch_boost:dir search;
dontaudit system_server proc_c2ps:dir search;
dontaudit system_server proc_ppb:dir search;


# Date: 2023/03/15
# Operation : MTBF
# Purpose : for remove sf rtt file
allow system_server sf_rtt_file:dir { relabelto r_dir_perms rmdir };
allow system_server sf_rtt_file:file r_file_perms;

# Purpose: allow MBrainJ find by MBrain
add_service(system_server, mtk_mbrainj_service)

# Dat: 2023/03/27
# Purpose: allow to get mbrain enable property
get_prop(system_server, vendor_mtk_mbrain_support_prop)

# Dat: 2023/07/24
# Purpose: allow to get magt enable property
get_prop(system_server, vendor_mtk_magt_support_prop)
get_prop(system_server, vendor_mtk_magt_version_prop)

# Data: 2023/08/31
# Operation: Add for MBrain
hal_client_domain(system_server, hal_mtk_mbrain)
get_prop(system_server, vendor_mtk_mbrain_support_prop)
